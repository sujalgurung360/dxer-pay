// ============================================================
// DXER Prisma Schema
// ============================================================
// Aligned with Supabase migrations. Uses db-level defaults.
// ============================================================

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model profiles {
  id                  String   @id @default(uuid()) @db.Uuid
  user_id             String   @unique @db.Uuid
  full_name           String
  email               String
  avatar_url          String?
  phone_number        String?
  verification_status String   @default("pending") // pending, verified, rejected
  verification_method String?  // manual, sheerid
  document_url        String?  // uploaded ID/document path
  created_at          DateTime @default(now()) @db.Timestamptz()
  updated_at          DateTime @default(now()) @updatedAt @db.Timestamptz()
}

model organizations {
  id                      String   @id @default(uuid()) @db.Uuid
  name                    String
  slug                    String   @unique
  owner_id                String   @db.Uuid
  registration_number     String?  // Business registration / tax ID
  ein                     String?  // EIN for tax forms
  business_type           String?  // LLC, Corporation, Sole Proprietor, etc.
  country                 String?
  address                 String?
  city                    String?
  state                   String?
  zip                     String?
  wallet_address          String?  // Polygon public address (auto-generated)
  wallet_private_key_enc  String?  // Encrypted private key (never exposed to client)
  metamask_address        String?  // User-connected MetaMask address (optional)
  created_at              DateTime @default(now()) @db.Timestamptz()
  updated_at              DateTime @default(now()) @updatedAt @db.Timestamptz()

  members             organization_members[]
  customers           customers[]
  employees           employees[]
  expenses            expenses[]
  fixed_assets        fixed_assets[]
  anomaly_detection_stats anomaly_detection_stats[]
  accounting_periods   accounting_periods[]
  contractors         contractors[]
  tax_packages        tax_packages[]
  invoices            invoices[]
  payrolls            payrolls[]
  production_batches  production_batches[]
  production_events   production_events[]
  device_identities   device_identities[]
  content_addresses   content_addresses[]
  audit_log           audit_log[]
  dxer_anchor_jobs    dxer_anchor_jobs[]
  dxer_sequences      dxer_sequences[]
  chart_of_accounts   chart_of_accounts[]
  journal_entries     journal_entries[]
}

model organization_members {
  id                  String   @id @default(uuid()) @db.Uuid
  org_id              String   @db.Uuid
  user_id             String   @db.Uuid
  role                String
  multichain_data_hex String?
  multichain_txid     String?
  polygon_txhash      String?
  created_at          DateTime @default(now()) @db.Timestamptz()
  updated_at          DateTime @default(now()) @updatedAt @db.Timestamptz()

  organization organizations @relation(fields: [org_id], references: [id], onDelete: Cascade)

  @@unique([org_id, user_id])
  @@index([org_id])
  @@index([user_id])
}

model customers {
  id                  String   @id @default(uuid()) @db.Uuid
  org_id              String   @db.Uuid
  name                String
  email               String?
  phone               String?
  address             String?
  tax_id              String?
  multichain_data_hex String?
  multichain_txid     String?
  polygon_txhash      String?
  created_at          DateTime @default(now()) @db.Timestamptz()
  updated_at          DateTime @default(now()) @updatedAt @db.Timestamptz()

  organization organizations @relation(fields: [org_id], references: [id], onDelete: Cascade)
  invoices     invoices[]

  @@index([org_id])
}

model employees {
  id                     String    @id @default(uuid()) @db.Uuid
  org_id                 String    @db.Uuid
  user_id                String?   @unique @db.Uuid
  full_name              String
  email                  String
  position               String?
  department             String?
  salary                 Decimal   @db.Decimal(15, 2)
  currency               String    @default("USD")
  start_date             DateTime  @db.Date
  is_active              Boolean   @default(true)
  wallet_address         String?
  wallet_private_key_enc String?
  onboarding_status      String    @default("draft")  // draft | invited | registered | verified | contract_signed | completed
  invite_token           String?   @unique
  invite_expires_at      DateTime? @db.Timestamptz()
  contract_signed_at     DateTime? @db.Timestamptz()
  ssn                    String?   // Encrypted in production
  address                String?
  city                   String?
  state                  String?
  zip                    String?
  filing_status          String?  // single, married, head_of_household
  multichain_data_hex    String?
  multichain_txid        String?
  polygon_txhash         String?
  created_at             DateTime  @default(now()) @db.Timestamptz()
  updated_at             DateTime  @default(now()) @updatedAt @db.Timestamptz()

  organization    organizations    @relation(fields: [org_id], references: [id], onDelete: Cascade)
  payroll_entries payroll_entries[]

  @@index([org_id])
}

model production_batches {
  id                  String    @id @default(uuid()) @db.Uuid
  org_id              String    @db.Uuid
  created_by          String    @db.Uuid
  name                String
  description         String?
  status              String    @default("planned")
  planned_start_date  DateTime? @db.Date
  planned_end_date    DateTime? @db.Date
  actual_start_date   DateTime? @db.Date
  actual_end_date     DateTime? @db.Date
  multichain_data_hex String?
  multichain_txid     String?
  polygon_txhash      String?
  created_at          DateTime  @default(now()) @db.Timestamptz()
  updated_at          DateTime  @default(now()) @updatedAt @db.Timestamptz()

  organization organizations      @relation(fields: [org_id], references: [id], onDelete: Cascade)
  events       production_events[]
  expenses     expenses[]

  @@index([org_id])
}

model production_events {
  id                  String   @id @default(uuid()) @db.Uuid
  org_id              String   @db.Uuid
  batch_id            String   @db.Uuid
  created_by          String   @db.Uuid
  event_type          String
  description         String?
  metadata            Json?
  multichain_data_hex String?
  multichain_txid     String?
  polygon_txhash      String?
  created_at          DateTime @default(now()) @db.Timestamptz()
  updated_at          DateTime @default(now()) @updatedAt @db.Timestamptz()

  organization organizations      @relation(fields: [org_id], references: [id], onDelete: Cascade)
  batch        production_batches @relation(fields: [batch_id], references: [id], onDelete: Cascade)

  @@index([batch_id])
  @@index([org_id])
}

model expenses {
  id                  String    @id @default(uuid()) @db.Uuid
  org_id              String    @db.Uuid
  created_by          String    @db.Uuid
  description         String
  amount              Decimal   @db.Decimal(15, 2)
  currency            String    @default("USD")
  category            String
  status              String    @default("pending")
  date                DateTime  @db.Date
  tags                String[]  @default([])
  notes               String?
  receipt_url         String?
  production_batch_id String?   @db.Uuid
  contractor_id       String?   @db.Uuid
  flags               Json?     // AI anomaly flags
  needs_review        Boolean?  @default(false)
  multichain_data_hex String?
  multichain_txid     String?
  polygon_txhash      String?
  created_at          DateTime  @default(now()) @db.Timestamptz()
  updated_at          DateTime  @default(now()) @updatedAt @db.Timestamptz()

  organization     organizations       @relation(fields: [org_id], references: [id], onDelete: Cascade)
  production_batch production_batches? @relation(fields: [production_batch_id], references: [id])
  contractor        contractors?       @relation(fields: [contractor_id], references: [id])

  @@index([org_id])
  @@index([org_id, date])
  @@index([org_id, status])
  @@index([contractor_id])
}

model fixed_assets {
  id                      String    @id @default(uuid()) @db.Uuid
  org_id                  String    @db.Uuid
  name                    String
  description             String?
  category                String?   // computers, furniture, vehicles, equipment, machinery
  purchase_date           DateTime  @db.Date
  cost                    Decimal   @db.Decimal(15, 2)
  useful_life_years       Int
  depreciation_method     String    @default("straight_line")
  salvage_value           Decimal   @default(0) @db.Decimal(12, 2)
  accumulated_depreciation Decimal @default(0) @db.Decimal(12, 2)
  status                  String    @default("active") // active, disposed, fully_depreciated
  disposal_date           DateTime? @db.Date
  disposal_proceeds       Decimal?  @db.Decimal(12, 2)
  disposal_method         String?  // sold, scrapped, donated, traded
  expense_id              String?   @db.Uuid
  multichain_data_hex     String?
  multichain_txid         String?
  polygon_txhash          String?
  created_at              DateTime  @default(now()) @db.Timestamptz()
  updated_at              DateTime  @default(now()) @updatedAt @db.Timestamptz()

  organization    organizations        @relation(fields: [org_id], references: [id], onDelete: Cascade)
  depreciation_entries depreciation_entries[]

  @@index([org_id])
  @@index([org_id, status])
}

model depreciation_entries {
  id                  String   @id @default(uuid()) @db.Uuid
  asset_id             String   @db.Uuid
  org_id               String   @db.Uuid
  period_year          Int
  period_month         Int
  depreciation_amount  Decimal  @db.Decimal(12, 2)
  accumulated_total   Decimal  @db.Decimal(12, 2)
  multichain_data_hex  String?
  multichain_txid      String?
  polygon_txhash       String?
  created_at           DateTime @default(now()) @db.Timestamptz()

  asset fixed_assets @relation(fields: [asset_id], references: [id], onDelete: Cascade)

  @@unique([asset_id, period_year, period_month])
  @@index([org_id, period_year, period_month])
}

model contractors {
  id                  String   @id @default(uuid()) @db.Uuid
  org_id              String   @db.Uuid
  name                String
  business_name       String?
  ein_or_ssn          String?
  address             String?
  city                String?
  state               String?
  zip                 String?
  email               String?
  phone               String?
  is_active           Boolean  @default(true)
  multichain_data_hex String?
  multichain_txid     String?
  polygon_txhash      String?
  created_at          DateTime @default(now()) @db.Timestamptz()
  updated_at          DateTime @default(now()) @updatedAt @db.Timestamptz()

  organization organizations @relation(fields: [org_id], references: [id], onDelete: Cascade)
  expenses     expenses[]

  @@index([org_id])
  @@index([org_id, is_active])
}

model tax_packages {
  id                  String    @id @default(uuid()) @db.Uuid
  org_id              String    @db.Uuid
  tax_year            Int
  package_type        String    @default("annual")
  status              String    @default("generating") // generating, completed, failed
  file_url            String?
  file_size_bytes     BigInt?
  generated_by        String?   @db.Uuid
  generated_at        DateTime  @default(now()) @db.Timestamptz()
  expires_at          DateTime? @db.Timestamptz()
  contents            Json?     // list of included filenames
  multichain_data_hex String?
  multichain_txid     String?
  polygon_txhash      String?

  organization organizations @relation(fields: [org_id], references: [id], onDelete: Cascade)

  @@index([org_id])
}

model invoices {
  id                  String   @id @default(uuid()) @db.Uuid
  org_id              String   @db.Uuid
  created_by          String   @db.Uuid
  customer_id         String   @db.Uuid
  invoice_number      String
  status              String   @default("draft")
  due_date            DateTime @db.Date
  currency            String   @default("USD")
  subtotal            Decimal  @default(0) @db.Decimal(15, 2)
  tax_rate            Decimal  @default(0) @db.Decimal(5, 2)
  tax_amount          Decimal  @default(0) @db.Decimal(15, 2)
  total               Decimal  @default(0) @db.Decimal(15, 2)
  notes               String?
  multichain_data_hex String?
  multichain_txid     String?
  polygon_txhash      String?
  created_at          DateTime @default(now()) @db.Timestamptz()
  updated_at          DateTime @default(now()) @updatedAt @db.Timestamptz()

  organization organizations        @relation(fields: [org_id], references: [id], onDelete: Cascade)
  customer     customers            @relation(fields: [customer_id], references: [id])
  line_items   invoice_line_items[]

  @@unique([org_id, invoice_number])
  @@index([org_id])
  @@index([customer_id])
  @@index([org_id, status])
}

model invoice_line_items {
  id          String   @id @default(uuid()) @db.Uuid
  invoice_id  String   @db.Uuid
  description String
  quantity    Decimal  @db.Decimal(15, 4)
  unit_price  Decimal  @db.Decimal(15, 2)
  amount      Decimal  @db.Decimal(15, 2)
  created_at  DateTime @default(now()) @db.Timestamptz()

  invoice invoices @relation(fields: [invoice_id], references: [id], onDelete: Cascade)

  @@index([invoice_id])
}

model payrolls {
  id                  String   @id @default(uuid()) @db.Uuid
  org_id              String   @db.Uuid
  created_by          String   @db.Uuid
  period_start        DateTime @db.Date
  period_end          DateTime @db.Date
  pay_date            DateTime @db.Date
  status              String   @default("draft")
  total_amount        Decimal  @default(0) @db.Decimal(15, 2)
  currency            String   @default("USD")
  notes               String?
  multichain_data_hex String?
  multichain_txid     String?
  polygon_txhash      String?
  created_at          DateTime @default(now()) @db.Timestamptz()
  updated_at          DateTime @default(now()) @updatedAt @db.Timestamptz()

  organization organizations    @relation(fields: [org_id], references: [id], onDelete: Cascade)
  entries      payroll_entries[]

  @@index([org_id])
}

model payroll_entries {
  id                     String   @id @default(uuid()) @db.Uuid
  payroll_id              String   @db.Uuid
  employee_id             String   @db.Uuid
  amount                  Decimal  @db.Decimal(15, 2)
  federal_withholding     Decimal? @db.Decimal(10, 2)
  state_withholding       Decimal? @db.Decimal(10, 2)
  social_security_tax     Decimal? @db.Decimal(10, 2)
  medicare_tax            Decimal? @db.Decimal(10, 2)
  state_unemployment_tax  Decimal? @db.Decimal(10, 2)
  multichain_data_hex     String?
  multichain_txid         String?
  polygon_txhash          String?
  created_at              DateTime @default(now()) @db.Timestamptz()

  payroll  payrolls  @relation(fields: [payroll_id], references: [id], onDelete: Cascade)
  employee employees @relation(fields: [employee_id], references: [id])

  @@index([payroll_id])
}

model device_identities {
  id           String    @id @default(uuid()) @db.Uuid
  org_id       String    @db.Uuid
  device_name  String
  public_key   String
  is_active    Boolean   @default(true)
  last_seen_at DateTime? @db.Timestamptz()
  created_at   DateTime  @default(now()) @db.Timestamptz()
  updated_at   DateTime  @default(now()) @updatedAt @db.Timestamptz()

  organization organizations @relation(fields: [org_id], references: [id], onDelete: Cascade)

  @@index([org_id])
}

model content_addresses {
  id             String   @id @default(uuid()) @db.Uuid
  org_id         String   @db.Uuid
  entity_type    String
  entity_id      String   @db.Uuid
  hash_algorithm String   @default("sha256")
  hash_value     String
  created_at     DateTime @default(now()) @db.Timestamptz()
  updated_at     DateTime @default(now()) @updatedAt @db.Timestamptz()

  organization organizations @relation(fields: [org_id], references: [id], onDelete: Cascade)

  @@index([entity_type, entity_id])
  @@index([org_id])
}

model audit_log {
  id                  String   @id @default(uuid()) @db.Uuid
  org_id              String   @db.Uuid
  user_id             String   @db.Uuid
  action              String
  entity_type         String
  entity_id           String   @db.Uuid
  version             Int      @default(1)              // Version chain: v1 → v2 → v3
  previous_hash       String?                            // SHA-256 hash of the previous version
  previous_polygon_tx String?                            // Polygon TX hash of previous version
  changed_fields      String[] @default([])              // List of fields that changed in this version
  before_data         Json?
  after_data          Json?
  ip_address          String?
  user_agent          String?
  multichain_data_hex String?
  multichain_txid     String?
  polygon_txhash      String?
  created_at          DateTime @default(now()) @db.Timestamptz()
  updated_at          DateTime @default(now()) @updatedAt @db.Timestamptz()

  organization organizations @relation(fields: [org_id], references: [id], onDelete: Cascade)

  @@index([org_id])
  @@index([entity_type, entity_id])
  @@index([user_id])
  @@index([org_id, created_at(sort: Desc)])
}

model chart_of_accounts {
  id                  String    @id @default(uuid()) @db.Uuid
  org_id              String    @db.Uuid
  account_code        String
  account_name        String
  account_type        String    // asset, liability, equity, revenue, expense, cogs
  parent_account_id   String?   @db.Uuid
  is_active           Boolean   @default(true)
  description         String?
  multichain_data_hex String?
  multichain_txid     String?
  polygon_txhash      String?
  created_at          DateTime  @default(now()) @db.Timestamptz()
  updated_at          DateTime  @default(now()) @updatedAt @db.Timestamptz()

  organization    organizations          @relation(fields: [org_id], references: [id], onDelete: Cascade)
  parent_account  chart_of_accounts?     @relation("AccountHierarchy", fields: [parent_account_id], references: [id])
  child_accounts  chart_of_accounts[]    @relation("AccountHierarchy")
  journal_lines   journal_entry_lines[]

  @@unique([org_id, account_code])
  @@index([org_id, is_active])
}

model journal_entries {
  id                  String    @id @default(uuid()) @db.Uuid
  org_id              String    @db.Uuid
  entry_number        String
  entry_date          DateTime  @db.Date
  description         String?
  reference_type      String?   // expense, invoice, payroll, depreciation, manual, opening_balance
  reference_id        String?   @db.Uuid
  status              String    @default("posted")   // draft, posted, voided
  created_by          String?   @db.Uuid
  voided_by           String?   @db.Uuid
  voided_at           DateTime? @db.Timestamptz()
  void_reason         String?
  multichain_data_hex String?
  multichain_txid     String?
  polygon_txhash      String?
  created_at          DateTime  @default(now()) @db.Timestamptz()
  updated_at          DateTime  @default(now()) @updatedAt @db.Timestamptz()

  organization organizations        @relation(fields: [org_id], references: [id], onDelete: Cascade)
  lines         journal_entry_lines[]

  @@unique([org_id, entry_number])
  @@index([org_id, entry_date])
  @@index([reference_type, reference_id])
  @@index([org_id, status])
}

model journal_entry_lines {
  id               String   @id @default(uuid()) @db.Uuid
  journal_entry_id String   @db.Uuid
  account_id       String?  @db.Uuid
  account_code     String
  account_name     String
  debit_amount     Decimal  @default(0) @db.Decimal(15, 2)
  credit_amount    Decimal  @default(0) @db.Decimal(15, 2)
  line_number      Int
  description      String?
  created_at       DateTime @default(now()) @db.Timestamptz()

  journal_entry journal_entries     @relation(fields: [journal_entry_id], references: [id], onDelete: Cascade)
  account       chart_of_accounts?  @relation(fields: [account_id], references: [id])

  @@index([journal_entry_id])
  @@index([account_code])
}

model dxer_system_config {
  id         String   @id @default(uuid()) @db.Uuid
  key        String   @unique
  value      Json     @default("{}")
  created_at DateTime @default(now()) @db.Timestamptz()
  updated_at DateTime @default(now()) @updatedAt @db.Timestamptz()
}

model dxer_anchor_jobs {
  id          String   @id @default(uuid()) @db.Uuid
  org_id      String   @db.Uuid
  entity_type String
  entity_id   String   @db.Uuid
  status      String   @default("pending")
  payload     Json?
  result      Json?
  error       String?
  created_at  DateTime @default(now()) @db.Timestamptz()
  updated_at  DateTime @default(now()) @updatedAt @db.Timestamptz()

  organization organizations @relation(fields: [org_id], references: [id], onDelete: Cascade)

  @@index([org_id])
  @@index([status])
}

model dxer_sequences {
  id          String @id @default(uuid()) @db.Uuid
  org_id      String @db.Uuid
  seq_name    String
  current_val BigInt @default(0)

  organization organizations @relation(fields: [org_id], references: [id], onDelete: Cascade)

  @@unique([org_id, seq_name])
}

model anomaly_detection_stats {
  id             String   @id @default(uuid()) @db.Uuid
  org_id         String   @db.Uuid
  date           DateTime @db.Date
  total_expenses Int      @default(0)
  flagged_count  Int      @default(0)
  flag_types     Json?    // {"duplicate": 5, "amount_spike": 2, ...}
  created_at     DateTime @default(now()) @db.Timestamptz()

  organization organizations @relation(fields: [org_id], references: [id], onDelete: Cascade)

  @@unique([org_id, date])
  @@index([org_id])
}

model accounting_periods {
  id                    String    @id @default(uuid()) @db.Uuid
  org_id                String    @db.Uuid
  period_type           String    // 'month', 'quarter', 'year'
  year                  Int
  month                 Int?      // 1-12 for monthly
  quarter               Int?      // 1-4 for quarterly
  start_date            DateTime  @db.Date
  end_date              DateTime  @db.Date
  status                String    @default("open") // open, closing, closed, reopened
  closed_by             String?   @db.Uuid
  closed_at             DateTime? @db.Timestamptz()
  reopened_by           String?   @db.Uuid
  reopened_at           DateTime? @db.Timestamptz()
  reopen_reason         String?
  final_balances        Json?
  multichain_data_hex   String?
  multichain_txid       String?
  polygon_txhash        String?
  created_at            DateTime  @default(now()) @db.Timestamptz()
  updated_at            DateTime  @default(now()) @updatedAt @db.Timestamptz()

  organization   organizations        @relation(fields: [org_id], references: [id], onDelete: Cascade)
  period_checks  period_close_checks[]

  @@unique([org_id, year, month, period_type])
  @@index([org_id, status])
}

model period_close_checks {
  id            String    @id @default(uuid()) @db.Uuid
  period_id     String    @db.Uuid
  check_type    String
  status        String    // passed, failed, warning, waived
  severity      String    // critical, high, medium, low
  message       String
  details       Json?
  resolved_by   String?   @db.Uuid
  resolved_at   DateTime? @db.Timestamptz()
  waived_by     String?   @db.Uuid
  waived_at     DateTime? @db.Timestamptz()
  waived_reason String?
  created_at    DateTime  @default(now()) @db.Timestamptz()

  period accounting_periods @relation(fields: [period_id], references: [id], onDelete: Cascade)

  @@index([period_id])
}
