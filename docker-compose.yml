# ============================================================
# DXER Docker Compose - Local Development
# ============================================================
# Usage: docker compose up -d
# This sets up Supabase locally (Postgres, Auth, Storage, Studio)
# and Multichain (private blockchain for anchoring).
# Then run: npm run dev (for API + Web)
# ============================================================

services:
  # ─── Supabase Postgres ───────────────────────────
  db:
    image: supabase/postgres:15.6.1.143
    container_name: dxer-db
    ports:
      - "54322:5432"
    environment:
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: postgres
      JWT_SECRET: super-secret-jwt-token-with-at-least-32-characters-long
      JWT_EXP: 3600
    volumes:
      - dxer-db-data:/var/lib/postgresql/data
      - ./supabase/migrations:/docker-entrypoint-initdb.d/migrations
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 10

  # ─── Supabase Auth (GoTrue) ─────────────────────
  auth:
    image: supabase/gotrue:v2.164.0
    container_name: dxer-auth
    depends_on:
      db:
        condition: service_healthy
    ports:
      - "9999:9999"
    environment:
      GOTRUE_API_HOST: 0.0.0.0
      GOTRUE_API_PORT: 9999
      API_EXTERNAL_URL: http://localhost:9999
      GOTRUE_DB_DRIVER: postgres
      GOTRUE_DB_DATABASE_URL: postgres://supabase_auth_admin:postgres@db:5432/postgres
      GOTRUE_SITE_URL: http://localhost:3000
      GOTRUE_URI_ALLOW_LIST: http://localhost:3000
      GOTRUE_DISABLE_SIGNUP: "false"
      GOTRUE_JWT_SECRET: super-secret-jwt-token-with-at-least-32-characters-long
      GOTRUE_JWT_EXP: 3600
      GOTRUE_JWT_DEFAULT_GROUP_NAME: authenticated
      GOTRUE_EXTERNAL_EMAIL_ENABLED: "true"
      GOTRUE_MAILER_AUTOCONFIRM: "true"
      GOTRUE_LOG_LEVEL: DEBUG

  # ─── Supabase REST (PostgREST) ──────────────────
  rest:
    image: postgrest/postgrest:v12.2.3
    container_name: dxer-rest
    depends_on:
      db:
        condition: service_healthy
    ports:
      - "54321:3000"
    environment:
      PGRST_DB_URI: postgres://authenticator:postgres@db:5432/postgres
      PGRST_DB_SCHEMAS: public,storage
      PGRST_DB_ANON_ROLE: anon
      PGRST_JWT_SECRET: super-secret-jwt-token-with-at-least-32-characters-long
      PGRST_DB_USE_LEGACY_GUCS: "false"

  # ─── Supabase Storage ───────────────────────────
  storage:
    image: supabase/storage-api:v1.11.13
    container_name: dxer-storage
    depends_on:
      db:
        condition: service_healthy
    ports:
      - "5000:5000"
    environment:
      ANON_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0
      SERVICE_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImV4cCI6MTk4MzgxMjk5Nn0.EGIM96RAZx35lJzdJsyH-qQwv8Hdp7fsn3W0YpN81IU
      DATABASE_URL: postgres://supabase_storage_admin:postgres@db:5432/postgres
      FILE_SIZE_LIMIT: 52428800
      STORAGE_BACKEND: file
      FILE_STORAGE_BACKEND_PATH: /var/lib/storage
      TENANT_ID: stub
      REGION: local
      GLOBAL_S3_BUCKET: stub
      IS_MULTITENANT: "false"
      POSTGREST_URL: http://rest:3000

  # ─── Supabase Studio (optional) ─────────────────
  studio:
    image: supabase/studio:latest
    container_name: dxer-studio
    depends_on:
      db:
        condition: service_healthy
    ports:
      - "54323:3000"
    environment:
      STUDIO_PG_META_URL: http://meta:8080
      POSTGRES_PASSWORD: postgres
      DEFAULT_ORGANIZATION_NAME: DXER
      DEFAULT_PROJECT_NAME: DXER Local
      SUPABASE_URL: http://rest:3000
      SUPABASE_PUBLIC_URL: http://localhost:54321
      SUPABASE_ANON_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0
      SUPABASE_SERVICE_ROLE_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImV4cCI6MTk4MzgxMjk5Nn0.EGIM96RAZx35lJzdJsyH-qQwv8Hdp7fsn3W0YpN81IU

  # ─── PG Meta ────────────────────────────────────
  meta:
    image: supabase/postgres-meta:v0.83.2
    container_name: dxer-meta
    depends_on:
      db:
        condition: service_healthy
    ports:
      - "8080:8080"
    environment:
      PG_META_PORT: 8080
      PG_META_DB_HOST: db
      PG_META_DB_PORT: 5432
      PG_META_DB_NAME: postgres
      PG_META_DB_USER: supabase_admin
      PG_META_DB_PASSWORD: postgres

  # ─── Multichain (private blockchain for anchoring) ───────
  multichain:
    build: ./multichain
    container_name: dxer-multichain
    ports:
      - "4798:4798"
    environment:
      MULTICHAIN_CHAIN_NAME: dxerchain
      MULTICHAIN_RPC_PORT: "4798"
      MULTICHAIN_RPC_USER: multichainrpc
      MULTICHAIN_RPC_PASSWORD: dxer123
      MULTICHAIN_RPC_ALLOW_IP: 0.0.0.0/0.0.0.0
    volumes:
      - dxer-multichain-data:/root/.multichain

volumes:
  dxer-db-data:
  dxer-multichain-data: